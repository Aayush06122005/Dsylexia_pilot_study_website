<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Dyslexia Research Study</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='landing_style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="primary-bg text-white py-4 shadow-lg">
        <div class="content-wrapper flex justify-between items-center">
            <div class="flex items-center">
                <img src="{{ url_for('static', filename='admin.jpg') }}" alt="Research Study" class="h-12 w-12 rounded-full mr-4 object-cover">
                <h1 class="text-xl md:text-2xl font-bold">Research Admin Portal</h1>
            </div>
            <nav>
                <ul class="flex space-x-6 text-lg items-center">
                    <li><a href="{{ url_for('landing') }}" class="hover:text-yellow-100 transition">Home</a></li>
                    <li><a href="#" id="logoutBtn" class="hover:text-yellow-100 transition bg-red-600 px-4 py-2 rounded">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="content-wrapper py-8">
        <!-- Dashboard Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <h3 class="text-lg font-semibold text-gray-700">Total Participants</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalParticipants">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                <h3 class="text-lg font-semibold text-gray-700">Active Studies</h3>
                <p class="text-3xl font-bold text-green-600" id="activeStudies">3</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                <h3 class="text-lg font-semibold text-gray-700">Data Quality Score</h3>
                <p class="text-3xl font-bold text-yellow-600" id="dataQuality">85%</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                <h3 class="text-lg font-semibold text-gray-700">Completion Rate</h3>
                <p class="text-3xl font-bold text-purple-600" id="completionRate">0%</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button class="tab-button active py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="users">
                        User Management
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="data">
                        Data Monitoring
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="export">
                        Dataset Export
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="tasks">
                        Task Management
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- User Management Tab -->
                <div id="users-tab" class="tab-content active">
                    <div class="flex justify-between items-center mb-6">
                        
                        <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="refreshUserData()">
                            Refresh Data
                        </button>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="mb-6 flex flex-wrap gap-4">
                        <input type="text" id="userSearch" placeholder="Search users..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button id="searchBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Search</button>
                    </div>

                    
                <!-- Parents -->
                    <div class="mb-10">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">Parents</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <!-- <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dyslexia Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> -->
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="parentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Parents data here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Children -->
                    <div class="mb-10">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">Children</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dyslexia Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="childrenTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Children data here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Schools -->
                    <div class="mb-2">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">Schools</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parents</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Children</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="schoolsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Schools data here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Data Monitoring Tab -->
                <div id="data-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Data Collection Monitoring</h2>
                    
                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Task Completion Rates</h3>
                            <canvas id="taskCompletionChart" width="400" height="200"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Data Quality Metrics</h3>
                            <canvas id="dataQualityChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Data Quality Indicators -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="font-semibold text-gray-700 mb-2">Audio Quality</h4>
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 92%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-600">92%</span>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="font-semibold text-gray-700 mb-2">Response Completeness</h4>
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 88%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-600">88%</span>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="font-semibold text-gray-700 mb-2">Data Consistency</h4>
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: 85%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-600">85%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Recent Data Collection Activity</h3>
                        <div id="recentActivity" class="space-y-3">
                            <!-- Activity items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Dataset Export Tab -->
                <div id="export-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Secure Dataset Export</h2>
                    
                    <!-- Export Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Export Configuration</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Format</label>
                                    <select id="exportFormat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="csv">CSV</option>
                                        <option value="json">JSON</option>
                                        <option value="excel">Excel</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Anonymization Level</label>
                                    <select id="anonymizationLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="full">Full Anonymization</option>
                                        <option value="partial">Partial Anonymization</option>
                                        <option value="none">No Anonymization (Admin Only)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                                    <div class="flex space-x-2">
                                        <input type="date" id="startDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <input type="date" id="endDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Data Selection</h3>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="includeDemographics" class="mr-3" checked>
                                    <span class="text-sm text-gray-700">Demographics Data</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="includeAudio" class="mr-3" checked>
                                    <span class="text-sm text-gray-700">Audio Recordings</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="includeTyping" class="mr-3" checked>
                                    <span class="text-sm text-gray-700">Typing Task Data</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="includeComprehension" class="mr-3" checked>
                                    <span class="text-sm text-gray-700">Comprehension Responses</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="includeProgress" class="mr-3" checked>
                                    <span class="text-sm text-gray-700">Task Progress Data</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Export Actions -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-wrap gap-4">
                            <button onclick="exportDataset()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-medium">
                                Export Dataset
                            </button>
                            <button onclick="previewExport()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium">
                                Preview Export
                            </button>
                            <button onclick="scheduleExport()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-medium">
                                Schedule Recurring Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Task Management Tab -->
                <div id="tasks-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Task Management</h2>
                    
                    <!-- Current Tasks -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Current Tasks</h3>
                            <div class="flex space-x-2">
                                <button onclick="loadTaskData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    Refresh Tasks
                                </button>
                                <button onclick="addNewTask()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    Add New Task
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Task Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estimated Time</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTableBody" class="divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                            Loading tasks... Click "Refresh Tasks" to load data.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="taskError" class="hidden mt-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                            <p class="text-red-700" id="taskErrorMessage"></p>
                        </div>
                    </div>

                    <!-- Task Parameters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Task Parameters</h3>
                            <div id="taskParameters" class="space-y-4">
                                <!-- Task parameters will be populated here -->
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Task Analytics</h3>
                            <canvas id="taskAnalyticsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="dark-bg text-white py-8 text-center">
        <div class="content-wrapper">
            <p>&copy; 2025 Dyslexia Research Study - Admin Portal. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modal for User Details -->
    <div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Participant Details</h3>
                        <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="userModalContent">
                        <!-- User details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Add this modal at the end of your admin.html body -->
<div id="addTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Add New Task</h3>
                    <button onclick="closeAddTaskModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="addTaskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Task Name</label>
                        <input type="text" id="newTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">One-line Description</label>
                        <input type="text" id="newTaskDesc" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Instructions</label>
                        <textarea id="newTaskInstructions" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Time (minutes)</label>
                        <input type="number" id="newTaskTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Devices Required</label>
                        <input type="text" id="newTaskDevices" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Example</label>
                        <textarea id="newTaskExample" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>

                    <!-- Add this to your addTaskForm in admin.html -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Main Content (HTML allowed)</label>
                        <textarea id="newTaskMainContent" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" onclick="closeAddTaskModal()" class="mr-3 px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Add Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
    <script>
        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                
                // Remove active class from all tabs and buttons
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Add active class to clicked tab and button
                document.getElementById(tabName + '-tab').classList.remove('hidden');
                document.getElementById(tabName + '-tab').classList.add('active');
                button.classList.add('active', 'border-blue-500', 'text-blue-600');
                button.classList.remove('border-transparent', 'text-gray-500');
                
                // Load tab-specific data
                loadTabData(tabName);
            });
        });

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadTabData('users');
            // Attach search/filter event listeners here
            document.getElementById('searchBtn').addEventListener('click', filterAndDisplayUsers);
            document.getElementById('userSearch').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') filterAndDisplayUsers();
            });
        });

        // Dashboard data loading
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/admin/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalParticipants').textContent = data.stats.totalParticipants;
                    document.getElementById('completionRate').textContent = data.stats.completionRate + '%';
                    document.getElementById('dataQuality').textContent = data.stats.dataQuality + '%';
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Tab-specific data loading
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'users':
                    await loadUserData();
                    break;
                case 'data':
                    await loadDataMonitoringData();
                    break;
                case 'export':
                    // Export tab doesn't need initial data loading
                    break;
                case 'tasks':
                    await loadTaskData();
                    break;
            }
        }

        let groupedUsers = { parents: [], children: [], schools: [] };
        let allUsers = [];

        async function loadUserData() {
            try {
                const response = await fetch('/api/admin/users-grouped');
                const data = await response.json();
                if (data.success) {
                    allUsers = data.users;
                    groupedUsers.parents = data.parents || [];
                    groupedUsers.children = data.children || [];
                    groupedUsers.schools = data.schools || [];
                    filterAndDisplayUsers();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function filterAndDisplayUsers() {
            const q = document.getElementById('userSearch').value.toLowerCase();
            const parents = groupedUsers.parents.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
            const children = groupedUsers.children.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
            const schools = groupedUsers.schools.filter(s => (s.name||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q));
            displayParents(parents);
            displayChildren(children);
            displaySchools(schools);
        }

         function renderUserRow(user) {
            return `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.age || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.dyslexia_status || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${user.progress || 0}%"></div>
                        </div>
                        <span class="text-sm text-gray-600">${user.progress || 0}%</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewUserDetails(${user.id})" class="text-blue-600 hover:text-blue-900 mr-3">View Details</button>
                    <button onclick="exportUserData(${user.id})" class="text-green-600 hover:text-green-900">Export</button>
                </td>
            `;
        }

        function renderParentRow(user) {
            return `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewUserDetails(${user.id})" class="text-blue-600 hover:text-blue-900 mr-3">View Details</button>
                    <button onclick="exportUserData(${user.id})" class="text-green-600 hover:text-green-900">Export</button>
                </td>
            `;
        }


        function displayParents(parents) {
            const tbody = document.getElementById('parentsTableBody');
            tbody.innerHTML = '';
            parents.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = renderParentRow(user);
                tbody.appendChild(row);
            });
        }

        function displayChildren(children) {
            const tbody = document.getElementById('childrenTableBody');
            tbody.innerHTML = '';
            children.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = renderUserRow(user);
                tbody.appendChild(row);
            });
        }

        function displaySchools(schools) {
            const tbody = document.getElementById('schoolsTableBody');
            tbody.innerHTML = '';
            schools.forEach(s => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.num_parents || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.num_children || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.phone || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="exportSchool(${s.id})" class="text-green-600 hover:text-green-900">Export</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    const modalContent = document.getElementById('userModalContent');
                    modalContent.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-700">Personal Information</h4>
                                <p><strong>Name:</strong> ${user.name}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Age:</strong> ${user.age || 'N/A'}</p>
                                <p><strong>Gender:</strong> ${user.gender || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700">Study Information</h4>
                                <p><strong>Dyslexia Status:</strong> ${user.dyslexia_status || 'N/A'}</p>
                                <p><strong>Education Level:</strong> ${user.education_level || 'N/A'}</p>
                                <p><strong>Native Language:</strong> ${user.native_language || 'N/A'}</p>
                                <p><strong>Registration Date:</strong> ${user.created_at}</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Task Progress</h4>
                            <div class="space-y-2">
                                ${user.tasks ? user.tasks.map(task => `
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                        <span>${task.task_name}</span>
                                        <select onchange="setUserTaskStatus(${user.id}, '${task.task_name}', this.value)" class="border rounded px-2 py-1 ml-2">
                                            <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                            <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    </div>
                                `).join('') : 'No task data available'}
                            </div>
                        </div>
                    `;
                    document.getElementById('userModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading user details:', error);
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // Data monitoring functions
        async function loadDataMonitoringData() {
            // Initialize charts
            initializeTaskCompletionChart();
            initializeDataQualityChart();
            initializeTaskAnalyticsChart();
            
            // Load recent activity
            await loadRecentActivity();
        }

        function initializeTaskCompletionChart() {
            const ctx = document.getElementById('taskCompletionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Reading Aloud', 'Typing Task', 'Comprehension'],
                    datasets: [{
                        data: [75, 68, 82],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function initializeDataQualityChart() {
            const ctx = document.getElementById('dataQualityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Audio Quality', 'Response Completeness', 'Data Consistency'],
                    datasets: [{
                        label: 'Quality Score (%)',
                        data: [92, 88, 85],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function initializeTaskAnalyticsChart() {
            const ctx = document.getElementById('taskAnalyticsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Task Completion Rate',
                        data: [65, 72, 78, 85],
                        borderColor: '#3B82F6',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/recent-activity');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('recentActivity');
                    container.innerHTML = data.activities.map(activity => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div>
                                <p class="text-sm font-medium text-gray-700">${activity.description}</p>
                                <p class="text-xs text-gray-500">${activity.timestamp}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${activity.type === 'completion' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${activity.type}</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // Export functions
        async function exportDataset() {
            const format = document.getElementById('exportFormat').value;
            const anonymization = document.getElementById('anonymizationLevel').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const includeData = {
                demographics: document.getElementById('includeDemographics').checked,
                audio: document.getElementById('includeAudio').checked,
                typing: document.getElementById('includeTyping').checked,
                comprehension: document.getElementById('includeComprehension').checked,
                progress: document.getElementById('includeProgress').checked
            };

            try {
                const response = await fetch('/api/admin/export-dataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format,
                        anonymization,
                        startDate,
                        endDate,
                        includeData
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dyslexia_study_data_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                console.error('Error exporting dataset:', error);
                alert('Error exporting dataset. Please try again.');
            }
        }

        function previewExport() {
            alert('Preview functionality will show a sample of the exported data.');
        }

        function scheduleExport() {
            alert('Schedule export functionality will allow setting up recurring exports.');
        }

        // Task management functions
        async function loadTaskData() {
            try {
                console.log('Loading task data...');
                
                // Hide any previous errors
                document.getElementById('taskError').classList.add('hidden');
                
                const response = await fetch('/api/admin/tasks');
                const data = await response.json();
                
                console.log('Task data response:', data);
                
                if (data.success) {
                    console.log('Tasks found:', data.tasks);
                    displayTasks(data.tasks);
                    displayTaskParameters(data.tasks);
                } else {
                    console.error('Failed to load tasks:', data.message);
                    showTaskError(data.message || 'Failed to load tasks');
                }
            } catch (error) {
                console.error('Error loading task data:', error);
                showTaskError('Network error: ' + error.message);
            }
        }

        function showTaskError(message) {
            const errorDiv = document.getElementById('taskError');
            const errorMessage = document.getElementById('taskErrorMessage');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function displayTasks(tasks) {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';
            
            // Clear any errors when tasks are displayed
            document.getElementById('taskError').classList.add('hidden');
            
            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No tasks found in the database
                        </td>
                    </tr>
                `;
                return;
            }
            
            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.task_name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.description ? 'Core Task' : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Active</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.estimated_time || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="viewTaskDetails(${task.id})" class="text-green-600 hover:text-green-900 mr-3">View</button>
                        <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        function displayTaskParameters(tasks) {
            const container = document.getElementById('taskParameters');
            container.innerHTML = '';
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No task parameters available</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="border border-gray-200 rounded p-4">
                    <h4 class="font-semibold text-gray-700 mb-2">${task.task_name || 'Unnamed Task'}</h4>
                    <div class="space-y-2 text-sm">
                        <p><strong>Description:</strong> ${task.description || 'No description available'}</p>
                        <p><strong>Estimated Time:</strong> ${task.estimated_time || 'Not specified'}</p>
                        <p><strong>Instructions:</strong> ${task.instructions || 'Standard instructions'}</p>
                        <p><strong>Devices Required:</strong> ${task.devices_required || 'Computer with internet'}</p>
                        <p><strong>Example:</strong> ${task.example || 'No example provided'}</p>
                    </div>
                </div>
            `).join('');
        }

        function addNewTask() {
            document.getElementById('addTaskModal').classList.remove('hidden');
            document.getElementById('addTaskForm').reset();
        }

        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task? This cannot be undone.')) return;
            fetch(`/api/admin/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Task deleted!');
                    loadTaskData();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(err => {
                alert('Error deleting task.');
                console.error(err);
            });
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addTaskForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('newTaskName').value.trim();
                const desc = document.getElementById('newTaskDesc').value.trim();
                const instructions = document.getElementById('newTaskInstructions').value.trim();
                const time = document.getElementById('newTaskTime').value.trim();
                const devices = document.getElementById('newTaskDevices').value.trim();
                const example = document.getElementById('newTaskExample').value.trim();
                const mainContent = document.getElementById('newTaskMainContent').value.trim();

                if (!name || !desc || !instructions || !time || !devices || !example || !mainContent) {
                    alert('Please fill in all fields.');
                    return;
                }
                const res = await fetch('/api/admin/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_name: name,
                        description: desc,
                        instructions: instructions,
                        estimated_time: time,
                        devices_required: devices,
                        example: example,
                        main_content: mainContent
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Task added!');
                    closeAddTaskModal();
                    loadTaskData();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        });

        function editTask(taskId) {
            // Fetch current task details
            fetch(`/api/admin/tasks`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const task = data.tasks.find(t => t.id === taskId);
                        if (!task) return alert('Task not found');
                        const newName = prompt('Edit task name:', task.task_name);
                        if (newName === null) return;
                        const newDesc = prompt('Edit description:', task.description || '');
                        if (newDesc === null) return;
                        fetch(`/api/admin/tasks/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ task_name: newName, description: newDesc })
                        })
                        .then(res => res.json())
                        .then(resp => {
                            if (resp.success) {
                                alert('Task updated!');
                                // Optionally refresh task list
                                location.reload();
                            } else {
                                alert('Error: ' + resp.message);
                            }
                        });
                    }
                });
        }

        function toggleTask(taskId) {
            alert(`Toggle task ${taskId} status functionality.`);
        }

        function viewTaskDetails(taskId) {
            // Fetch current task details
            fetch(`/api/admin/tasks`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const task = data.tasks.find(t => t.id === taskId);
                        if (!task) return alert('Task not found');
                        
                        const details = `
Task Name: ${task.task_name || 'N/A'}
Description: ${task.description || 'N/A'}
Instructions: ${task.instructions || 'N/A'}
Estimated Time: ${task.estimated_time || 'N/A'}
Devices Required: ${task.devices_required || 'N/A'}
Example: ${task.example || 'N/A'}
                        `;
                        alert(details);
                    }
                })
                .catch(err => {
                    alert('Error loading task details');
                    console.error(err);
                });
        }

        // Utility functions
        function refreshUserData() {
            loadUserData();
        }

        async function exportUserData(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/export`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `user_${userId}_data.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                console.error('Error exporting user data:', error);
            }
        }

        function exportSchool(schoolId) {
            alert('School export is not implemented yet.');
        }

        function setUserTaskStatus(userId, taskName, status) {
            fetch('/api/admin/set-user-task-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, task_name: taskName, status: status })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Task status updated!');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(() => alert('Network error.'));
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/admin/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });
    </script>
</body>
</html> 